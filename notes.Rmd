---
title: "Some Technical Notes"
author: "Jialin Ma"
date: "February 10, 2017"
output:
    rmarkdown::html_document:
        toc: true
        toc_float: true
        theme: flatly
---


## Technical Notes

### TnT libraries

TnT is a set of javascript visualization libraries that include a simple genome
browser, you can see http://tntvis.github.io/tnt.genome/index.html for what it may
achieve. The aim of this package is to wrap the TnT libraries into R so that we
can eaisly create interactive track-based visulization in Rmarkdown and shiny apps
using data from R environment (as the example above).

### htmlwidgets

This package is based on the htmlwidgets framework to wrap the TnT library into
R, you can find some great packages that utilizes htmlwidgets
at [here](http://www.htmlwidgets.org/showcase_leaflet.html). Packages that are
based on htmlwidgets can be used in Rmarkdown files and shiny webapps. 

### TnT api

Basicly, the creation of a tnt component need a definition about the component
as a javascript function cascade,
which includes the general properties, track properties, track data, etc. For the
TnT board library, you can find documentation of the these api at 
http://tntvis.github.io/tnt.board/api/board/index.html .

For example, the following is the definition of the tnt board at the beginning of
this page.

```js
tnt.board()
.from(14)
.to(114)
.min(-100)
.max(500)
.allow_drag(true)
.add_track(tnt.board.track()
           .color('white')
           .height(20)
           .display(tnt.board.track.feature.location()))
.add_track(tnt.board.track()
           .height(0)
           .display(tnt.board.track.feature.axis()
                    .orientation('top')))
.add_track(tnt.board.track()
           .color('white')
           .height(40)
           .label('My Track 1')
           .data(tnt.board.track.data.sync()
                 .retriever(function () {
                     return [{"start":42,"end":54},{"start":69,"end":99},{"start":233,"end":250}]
                 }))
           .display(tnt.board.track.feature.block()
                    .color('black')))
.add_track(tnt.board.track()
           .color('white')
           .height(40)
           .label('My Track 2')
           .data(tnt.board.track.data.sync()
                 .retriever(function () {
                     return [{"start":23,"end":38},{"start":66,"end":74},{"start":300,"end":318}]
                 }))
           .display(tnt.board.track.feature.block()
                    .color('green')))
```

### Pass information from R to JS

Based on the fact that definition of tnt components are linked by javascript functions
with mostly single argument (either numeric, character or another function result),
I decided to use a somehow "violent" approach to pass information/data from R side
to javascript side -- to directly generate this character string as javascript code
and pass it to javascript side.

For example,

```{r}
library(TnT)
tntdef <-
"
  tnt.board()
  .from(14)
  .to(114)
  .min(-100)
  .max(500)
  .allow_drag(true)
  .add_track(tnt.board.track()
             .color('white')
             .height(20)
             .display(tnt.board.track.feature.location()))
  .add_track(tnt.board.track()
             .height(0)
             .display(tnt.board.track.feature.axis()
                      .orientation('top')))
  .add_track(tnt.board.track()
             .color('white')
             .height(40)
             .label('My Track 1')
             .data(tnt.board.track.data.sync()
                   .retriever(function () {
                       return [{'start':42,'end':54},{'start':69,'end':99},{'start':233,'end':250}]
                   }))
             .display(tnt.board.track.feature.block()
                      .color('black')))
  .add_track(tnt.board.track()
             .color('white')
             .height(40)
             .label('My Track 2')
             .data(tnt.board.track.data.sync()
                   .retriever(function () {
                       return [{'start':23,'end':38},{'start':66,'end':74},{'start':300,'end':318}]
                   }))
             .display(tnt.board.track.feature.block()
                      .color('green')))
"
TnT(tntdef)
```

In the example above, the character vector `tntdef` is passed from R side to JS side as
an option of the htmlwidgets framework (by `TnT` function).
The JS side is handled at [inst/htmlwidgets/TnT.js](inst/htmlwidgets/TnT.js), which
is simply `eval` and initiated (only three lines of code).


### Model the api

If based on my approach obove, the goal of this package is to provide functions
that can generate these javascript code from common R function calls. But first,
I consider it would be better to model the api on R side. I use a list structure
to model the api -- name as the js function name, list body as argument of
the js function, then assign class attribute and provide methods to make it a S3 
object. I name this class "JScascade".

For example,

```{r}
myjc <- JScascade(
    tnt.board = NULL,
    from = 0,
    to = 500,
    min = 50,
    max = 1000,
    width = 500,
    add_track = JScascade(
        tnt.board.track = NULL,
        height = 20,
        color = "white",
        display = JScascade(tnt.board.track.feature.axis = NULL)
    ),
    add_track = JScascade(
        tnt.board.track = NULL,
        height = 30,
        color = "yellow",
        data = JScascade(
            tnt.board.track.data.sync = NULL,
            retriever = JS("function() {return [{start : 200, end : 350}]}")
        ),
        display = JScascade(
            tnt.board.track.feature.block = NULL,
            color = "blue",
            index = JS("function (d) {return d.start}")
        )
    )
) 
myjc
```

It is essentially a list:

```{r}
str(myjc)
```


A "JScascade" object can be easily converted to javascript code using function `asJS`.
For example,

```{r}
asJS(myjc)
```

And it can be directly utilized by `TnT` function:

```{r}
TnT(myjc)
```


Other functions in this package are aimmed at this class and provide ways to create/combine
`JScascade` objects.


### Further

Currently I have only wrapped the
[tnt board api](http://tntvis.github.io/tnt.board/api/board/index.html) and provide
limited user-side functions. This package further need to wrap other tnt libraries
(tnt genome, tnt tooltip, etc.) and provide more user-side
functions to help easily convert R/bioconductor data into tnt components.
Also, for visulization of large datasets in shiny app, consider how to serve
the data on the server-side (like the `DT` package).

